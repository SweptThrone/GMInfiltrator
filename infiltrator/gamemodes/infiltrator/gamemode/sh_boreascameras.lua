local cameras = {
    { pos = Vector( -575.10864257813, 952.740234375 , -6213.0361328125 ), ang = Angle( -0.094664096832275, -116.95151519775, 0.73023986816406 ) },
    { pos = Vector( -156.11959838867, 112.96598052979 , -6211.6279296875 ), ang = Angle( -0.074805565178394, 62.496212005615, -0.40811157226563 ) },
    { pos = Vector( -205.00263977051, 695.31811523438 , -6213.669921875 ), ang = Angle( 0.2251842468977, 151.26402282715, 1.4440765380859 ) },
    { pos = Vector( 304.31112670898, 960.45947265625 , -6302.052734375 ), ang = Angle( 0, 0, 0 ) },
    { pos = Vector( 896.49810791016, 1691.2209472656 , -6298.3295898438 ), ang = Angle( 0, -90, 0 ) },
    { pos = Vector( 879.57745361328, 1696.4147949219 , -6317.80078125 ), ang = Angle( 0, 90, 0 ) },
    { pos = Vector( 544.54846191406, 1611.2796630859 , -6318.658203125 ), ang = Angle( 0, -90, 0 ) },
    { pos = Vector( 0.50555765628815, 2624.7924804688 , -6300.2553710938 ), ang = Angle( 0, -90, 0 ) },
    { pos = Vector( -33.643711090088, 2639.6279296875 , -6288.5581054688 ), ang = Angle( 0, -180, 0 ) },
    { pos = Vector( -927.86639404297, 2874.3393554688 , -6284.6176757813 ), ang = Angle( 0, -90, 0 ) },
    { pos = Vector( 143.89619445801, 2090.1022949219 , -6316.5288085938 ), ang = Angle( 0, -90, 0 ) },
    { pos = Vector( 161.26953125, 2343.7944335938 , -6308.6743164063 ), ang = Angle( 0, 0, 0 ) },
    { pos = Vector( 840.46423339844, 2783.5725097656 , -6300.4233398438 ), ang = Angle( 0, 180, 0 ) },
    { pos = Vector( 637.51898193359, 3055.7995605469 , -6300.4272460938 ), ang = Angle( 0, 180, 0 ) },
    { pos = Vector( 1838.7598876953, 3302.0268554688 , -6170.92578125 ), ang = Angle( 0, -135, 0 ) },
    { pos = Vector( 1920.1879882813, 4585.5102539063 , -6173.2236328125 ), ang = Angle( 0, -90, 0 ) },
    { pos = Vector( 1425.3956298828, 3312.3820800781 , -6025.72265625 ), ang = Angle( 0, 0, 0 ) },
    { pos = Vector( 1695.5263671875, 4399.5751953125 , -6066.3759765625 ), ang = Angle( 0, -180, 0 ) },
    { pos = Vector( 1854.9291992188, 2832.2700195313 , -6170.1508789063 ), ang = Angle( 0, 0, 0 ) },
    { pos = Vector( 1873.6136474609, 2304.3200683594 , -6177.4921875 ), ang = Angle( 0, 0, 0 ) },
    { pos = Vector( 2495.7590332031, 3726.6450195313 , -6112.3349609375 ), ang = Angle( 0, 90, 0 ) },
    { pos = Vector( -1023.6010131836, 3702.6008300781 , -6085.634765625 ), ang = Angle( 0, -90, 0 ) },
    { pos = Vector( 985.25970458984, 3839.7263183594 , -6187.8017578125 ), ang = Angle( 0, -180, 0 ) },
    { pos = Vector( 1073.2506103516, 4438.5947265625 , -6251.1938476563 ), ang = Angle( 0, 0, 0 ) },
    { pos = Vector( 895.59173583984, 4113.8061523438 , -6303.3671875 ), ang = Angle( 0, 90, 0 ) },
    { pos = Vector( -213.01684570313, 4882.6303710938 , -6250.0024414063 ), ang = Angle( 0, -135, 0 ) },
    { pos = Vector( 895.10626220703, 5360.4233398438 , -6239.4516601563 ), ang = Angle( 0, -180, 0 ) },
    { pos = Vector( 638.23022460938, 4880.248046875 , -6166.0693359375 ), ang = Angle( 0, 0, 0 ) },
    { pos = Vector( 1600.6002197266, 5034.484375 , -6159.990234375 ), ang = Angle( 0, -90, 0 ) },
    { pos = Vector( 1485.1214599609, 4591.9736328125 , -6180.162109375 ), ang = Angle( 0, 0, 0 ) },
    { pos = Vector( 2478.1516113281, 5056.4624023438 , -6156.0180664063 ), ang = Angle( 0, -180, 0 ) },
    { pos = Vector( -73.16471862793, 5096.5546875 , -6015.3696289063 ), ang = Angle( 0, 135, 0 ) },
    { pos = Vector( -136.03330993652, 4770.2919921875 , -5227.09765625 ), ang = Angle( 0, 90, 0 ) },
    { pos = Vector( 94.92903137207, 5263.8916015625 , -5228.4243164063 ), ang = Angle( 0, 180, 0 ) },
    { pos = Vector( 599.04254150391, 4343.064453125 , -4806.0063476563 ), ang = Angle( 0, 44.999996185303, 0 ) },
    { pos = Vector( -775.34539794922, 754.138671875 , -6194.7626953125 ), ang = Angle( 0.082427181303501, 64.478141784668, 2.4104919433594 ) },
    { pos = Vector( 2208.5991210938, -14720.384765625 , -6423.6728515625 ), ang = Angle( 0, 180, 0 ) },
    --{ pos = Vector( 1280.6702880859, -14839.40234375 , -6462.501953125 ), ang = Angle( 0, 0, 0 ) },
    --{ pos = Vector( 719.40759277344, -15287.270507813 , -6459.9560546875 ), ang = Angle( 0, 0, 0 ) },
    --{ pos = Vector( 568.89038085938, -14535.375 , -6458.83203125 ), ang = Angle( 0, 0, 0 ) },
    --{ pos = Vector( 1448.9802246094, -14711.6015625 , -6411.8608398438 ), ang = Angle( 0, 0, 0 ) },
    { pos = Vector( 816.45831298828, 3584.0783691406 , -6547.9340820313 ), ang = Angle( 0, -90, 0 ) },
    { pos = Vector( 1863.5571289063, 5791.3408203125 , -6526.830078125 ), ang = Angle( 0, 180, 0 ) }
}

BOREAS_CAMERAS = {}

if SERVER then
    util.AddNetworkString( "boreas_cameras" )

    hook.Add( "InitPostEntity", "SpawnCameraProps", function()
        for k,v in pairs( cameras ) do
            local camera = ents.Create( "infil_camera" )
            camera:SetPos( v.pos )
            camera:SetAngles( v.ang )
            camera:Spawn()
            camera:DrawShadow( false )
            camera:GetPhysicsObject():EnableMotion( false )
            BOREAS_CAMERAS[ k ] = camera
        end
    end )

    hook.Add( "PostCleanupMap", "ResetupCameras", function()
        BOREAS_CAMERAS = {}
        
        for k,v in pairs( cameras ) do
            local camera = ents.Create( "infil_camera" )
            camera:SetPos( v.pos )
            camera:SetAngles( v.ang )
            camera:Spawn()
            camera:DrawShadow( false )
            camera:GetPhysicsObject():EnableMotion( false )
            BOREAS_CAMERAS[ k ] = camera
        end
    end )

    local lastCams = {}

    hook.Add( "SetupPlayerVisibility", "AddRTCamera", function( ply, v )
        if IsValid( v ) then AddOriginToPVS( v:GetPos() - ( v:GetRight() * 15 ) + ( v:GetForward() * 35 ) ) end
    end )

    net.Receive( "boreas_cameras", function( _, ply )
        local camera = net.ReadInt( 32 )
        if camera == 0 then
            camera = #BOREAS_CAMERAS
        elseif camera > #BOREAS_CAMERAS then
            camera = 1
        end

        if camera == -1 then
            if lastCams[ ply ] then BOREAS_CAMERAS[ lastCams[ ply ] ]:SetNWInt( "Watchers", BOREAS_CAMERAS[ lastCams[ ply ] ]:GetNWInt( "Watchers", 0 ) - 1 ) end
            ply:SetViewEntity( NULL )
            ply:Freeze( false )
        else
            if lastCams[ ply ] then BOREAS_CAMERAS[ lastCams[ ply ] ]:SetNWInt( "Watchers", BOREAS_CAMERAS[ lastCams[ ply ] ]:GetNWInt( "Watchers", 0 ) - 1 ) end
            lastCams[ ply ] = camera
            BOREAS_CAMERAS[ camera ]:SetNWInt( "Watchers", BOREAS_CAMERAS[ camera ]:GetNWInt( "Watchers", 0 ) + 1 )  
            ply:SetViewEntity( BOREAS_CAMERAS[ camera ] ) 
            net.Start( "boreas_cameras" )
                net.WriteBool( false )
                net.WriteUInt( camera, 32 )
                net.WriteEntity( BOREAS_CAMERAS[ camera ] )
            net.Send( ply )
        end
    end )

    hook.Add( "PlayerDeath", "UnfreezeCamWhenKilled", function( ply )
        ply:Freeze( false )
    end )
end

if CLIENT then
    surface.CreateFont( "CharMenuArrow", {
        font = "Roboto",
        size = ScreenScale( 36 ),
        weight = 2000
    } )
    surface.CreateFont( "CharMenuArrowSm", {
        font = "Roboto",
        size = ScreenScale( 26 ),
        weight = 2000
    } )

    hook.Add( "PostCleanupMap", "ResetupCamerasTab", function()
        BOREAS_CAMERAS = {}
    end )

    local observingCamera = 0
    local staticCam = false

    hook.Add( "CalcView", "LookThroughCamera", function( ply, pos, ang, fov )
        if observingCamera == 0 then return end
        local v = BOREAS_CAMERAS[ observingCamera ]
        if not IsValid( v ) or not v:GetNWBool( "Enabled" ) then
            staticCam = true
            return
        end
        staticCam = false
        local view = {
            origin = v:GetPos() - ( v:GetRight() * 15 ) + ( v:GetForward() * 35 ),
            angles = v:GetAngles() + Angle( 25, 30, 0 ),
            fov = 90,
            drawviewer = true
        }
        return view
    end )

    local staticOverlay = Material( "effects/tvscreen_noise001a" )
    local camOverlay = Material( "effects/combine_binocoverlay" )

    hook.Add( "RenderScreenspaceEffects", "DrawTVStatic", function()
        if staticCam and observingCamera ~= 0 then

            render.UpdateScreenEffectTexture()

            staticOverlay:SetFloat( "$envmap", 0 )
            staticOverlay:SetFloat( "$envmaptint", 0 )
            staticOverlay:SetFloat( "$refractamount", 0 )
            staticOverlay:SetInt( "$ignorez", 1 )

            render.SetMaterial( staticOverlay )
            render.DrawScreenQuad( true )

        elseif observingCamera ~= 0 then

            render.UpdateScreenEffectTexture()

            camOverlay:SetFloat( "$envmap", 0 )
            camOverlay:SetFloat( "$envmaptint", 0 )
            camOverlay:SetFloat( "$refractamount", 0 )
            camOverlay:SetInt( "$ignorez", 1 )

            render.SetMaterial( camOverlay )
            render.DrawScreenQuad( true )
            
        end
    end )

    net.Receive( "boreas_cameras", function()
        local op = net.ReadBool()

        if op then
            local index = net.ReadUInt( 32 )
            local ent = net.ReadUInt( 32 )
            BOREAS_CAMERAS[ index ] = Entity( ent )
            observingCamera = index

            local winW = ScrH() * ( 16/9 )
            STRP_CharWindow = vgui.Create( "DFrame" )
            STRP_CharWindow:SetPos( 5, 5 )
            STRP_CharWindow:SetSize( math.min( winW, ScrW() ), ScrH() )
            STRP_CharWindow:SetTitle( "" )
            STRP_CharWindow:SetVisible( true )
            STRP_CharWindow:SetDraggable( false )
            STRP_CharWindow:ShowCloseButton( false )
            STRP_CharWindow:MakePopup()
            STRP_CharWindow:Center()
            STRP_CharWindow:SetKeyboardInputEnabled( false )
            STRP_CharWindow.Paint = function( self, w, h )
                surface.SetTextColor( 0, 0, 0, 255 )
            end
            function STRP_CharWindow:Think()
                if not LocalPlayer():Alive() then
                    observingCamera = 0
                    net.Start( "boreas_cameras" )
                        net.WriteInt( -1, 32 )
                    net.SendToServer()
                    STRP_CharWindow:Close()
                end
            end

            local ModelLeftButton = vgui.Create( "DButton", STRP_CharWindow )
            ModelLeftButton:SetPos( 0, ScrH() / 3 )
            ModelLeftButton:SetSize( math.min( winW, ScrW() ) * 0.05, ScrH() / 3 )
            ModelLeftButton:SetFont( "CharMenuArrow" )
            ModelLeftButton:SetText( "◀" )
            function ModelLeftButton:DoClick()
                observingCamera = observingCamera - 1
                --if observingCamera <= 0 then
                --    observingCamera = #BOREAS_CAMERAS
                --end
                --LocalPlayer():SetModel( citizenModels[ randModel ] )
                net.Start( "boreas_cameras" )
                    net.WriteInt( observingCamera, 32 )
                net.SendToServer()
            end

            local ModelRightButton = vgui.Create( "DButton", STRP_CharWindow )
            ModelRightButton:SetPos( math.min( winW, ScrW() ) - math.min( winW, ScrW() ) * 0.05, ScrH() / 3 )
            ModelRightButton:SetSize( math.min( winW, ScrW() ) * 0.05, ScrH() / 3 )
            ModelRightButton:SetFont( "CharMenuArrow" )
            ModelRightButton:SetText( "▶" )
            function ModelRightButton:DoClick()
                observingCamera = observingCamera + 1
                --if observingCamera > #BOREAS_CAMERAS then
                --    observingCamera = 1
                --end
                --LocalPlayer():SetModel( citizenModels[ randModel ] )
                net.Start( "boreas_cameras" )
                    net.WriteInt( observingCamera, 32 )
                net.SendToServer()
            end

            local ConfirmButton = vgui.Create( "DButton", STRP_CharWindow )
            ConfirmButton:SetPos( math.min( winW, ScrW() ) / 2.66, ScrH() - ScrH() * 0.1 )
            ConfirmButton:SetSize( math.min( winW, ScrW() ) / 4, ScrH() * 0.1 )
            ConfirmButton:SetFont( "CharMenuArrowSm" )
            ConfirmButton:SetTextColor( color_black )
            ConfirmButton:SetText( "Exit" )
            function ConfirmButton:DoClick()
                observingCamera = 0
                net.Start( "boreas_cameras" )
                    net.WriteInt( -1, 32 )
                net.SendToServer()
                STRP_CharWindow:Close()
            end
        else
            local index = net.ReadUInt( 32 )
            local ent = net.ReadEntity()
            BOREAS_CAMERAS[ index ] = ent
            observingCamera = index
        end
    end )
end